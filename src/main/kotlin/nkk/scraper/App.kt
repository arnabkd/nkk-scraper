/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package nkk.scraper

import org.jsoup.Jsoup
import org.jsoup.nodes.Element

const val goldenURL = "https://retrieverklubben.no/golden-retriever/oppdretterliste/"

// CSS selectors
const val sectionSelector = "body > div.main_container > div.oppdretterliste_section"
const val breederListClass = "oppdretterliste_post_container"
fun getFylke(it: Element): Fylke? {
  val content = it.select("h5").first()
  return when (content) {
    null -> null
    else -> Fylke.values().first { it.fullName == content.text() }
  }
}

fun getBreeders(element: Element, fylke: Fylke): List<Breeder> =
  element
    .select("div.oppdretterliste_box")
    .map {row ->
      row
        .select("p > span")
        .map { it.text().split(":") }
        .filter { it.size == 2 }
        .map { it[0] to it[1] }
        .toBreeder(fylke)
    }


fun printBreederTable(url: String) {
  val breeders = Jsoup
    .connect(url)
    .get()
    .select(sectionSelector)
    .asSequence()
    .map {
      it.children()
    }
    .first()
    .asSequence()
    .filter { it.hasClass(breederListClass) }
    .map { fylkeHTML ->
      val fylke = getFylke(fylkeHTML)
      check(fylke != null)
      getBreeders(fylkeHTML, fylke)
    }
    .flatten()
    .sortedBy { it.fylke }
    .toList()
  breeders.writeToCSV("breeders.csv")

}

data class Breeder(
  val fylke: Fylke? = null,
  val name: String? = null,
  val kennelName: String? = null,
  val address: String? = null,
  val phone: String? = null,
  val email: String? = null,
  val url: String? = null
)

enum class Fylke(val fullName: String) {
  AGDER("Agder"),
  INNLANDET("Innlandet"),
  MORE_OG_ROMSDAL("Møre og Romsdal"),
  NORDLAND("Nordland"),
  OSLO("Oslo"),
  ROGALAND("Rogaland"),
  TROMS_OG_FINNMARK("Troms og Finmark"),
  TRONDELAG("Trøndelag"),
  VESTFOLD_OG_TELEMARK("Vestfold og Telemark"),
  VESTLAND("Vestland"),
  VIKEN("Viken")
}

fun main() {
  printBreederTable(goldenURL)
}
